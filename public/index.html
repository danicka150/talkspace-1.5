<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>TalkSpace</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body { font-family: Arial; margin:0; padding:0; display:flex; flex-direction:column; height:100vh; }
#header { padding:10px; background:#111; color:white; display:flex; justify-content:space-between; align-items:center; }
#chat { flex:1; overflow-y:auto; padding:10px; background:#222; color:white; }
input,button,select { padding:5px; margin:2px; }
#settings { position:absolute; top:50px; right:10px; background:#333; color:white; padding:10px; display:none; }
body.light { background:#eef; color:#000; }
body.light #chat { background:#ccf; color:#000; }
body.light #header { background:#88c; color:#000; }
.group { border:1px solid #555; padding:5px; margin:2px; cursor:pointer; }
</style>
</head>
<body>
<div id="header">
  <span id="userDisplay">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
  <div>
    <button onclick="toggleSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <button onclick="logout()">–í—ã—Ö–æ–¥</button>
  </div>
</div>

<div id="settings">
  <label>–¢–µ–º–∞:
    <select id="themeSelect" onchange="changeTheme()">
      <option value="dark">–¢—ë–º–Ω–∞—è üåô</option>
      <option value="light">–°–≤–µ—Ç–ª–∞—è ‚òÄÔ∏è</option>
    </select>
  </label>
  <br>
  <label>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É: <input id="groupName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã"><button onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button></label>
</div>

<div id="chat"></div>
<input id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
<button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

<div id="groups"></div>

<script>
const socket = io();
let nick = null;
let currentGroup = null;

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
function append(msg){ const c=document.createElement('div'); c.textContent=msg; document.getElementById('chat').appendChild(c); document.getElementById('chat').scrollTop=1e6; }

function login(name){ nick=name; document.getElementById('userDisplay').textContent=nick; socket.emit('join', nick); append('–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ '+nick); }
function logout(){ nick=null; document.getElementById('userDisplay').textContent='–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'; append('–í—ã –≤—ã—à–ª–∏'); }

function sendMessage(){ 
  if(!nick)return alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); 
  const msg=document.getElementById('msgInput').value; 
  if(!msg)return; 
  if(currentGroup){
    socket.emit('groupMessage', { groupId: currentGroup, msg: msg });
  }else{
    socket.emit('chatAll', msg); 
  }
  document.getElementById('msgInput').value='';
}

socket.on('chatAll', data=>append(data.nick+': '+data.msg));
socket.on('groupMessage', data=>{ if(data.groupId===currentGroup) append(data.from+'@'+data.groupId+': '+data.msg); });

// –¢–µ–º—ã
function toggleSettings(){ const s=document.getElementById('settings'); s.style.display=s.style.display==='none'?'block':'none'; }
function changeTheme(){ document.body.className=document.getElementById('themeSelect').value; }

// –ì—Ä—É–ø–ø—ã
function createGroup(){ 
  const name=document.getElementById('groupName').value;
  if(!name)return;
  const pub=true;
  socket.emit('createGroup', {name:name, public:pub}, res=>{ document.getElementById('groupName').value=''; });
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–≤—Ö–æ–¥ –¥–ª—è —Ç–µ—Å—Ç–∞
let namePrompt=prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫:");
if(namePrompt)login(namePrompt);

// –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
socket.emit('fetchInit', function(data){
  if(data.groups) for(let g in data.groups){
    const div=document.createElement('div');
    div.textContent=data.groups[g].name;
    div.className='group';
    div.onclick=function(){ currentGroup=g; document.getElementById('chat').innerHTML=''; append('–û—Ç–∫—Ä—ã—Ç —á–∞—Ç –≥—Ä—É–ø–ø—ã '+data.groups[g].name); };
    document.getElementById('groups').appendChild(div);
  }
});
</script>
</body>
</html>
