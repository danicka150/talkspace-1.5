<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TalkSpace</title>
<style>
:root {
  --bg: #000;
  --text: #0f0;
  --bubble-me: #032;
  --bubble-other: #060;
  --card: #0a0a0a;
  --accent: #0f0;
}
.light {
  --bg: #fff;
  --text: #00f;
  --bubble-me: #ccf;
  --bubble-other: #bbf;
  --card: #eef;
  --accent: #00f;
}
body {
  font-family: Arial, sans-serif;
  background-color: var(--bg);
  color: var(--text);
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
}
header {
  background: var(--card);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  box-shadow: 0 2px 5px #0004;
}
#themeToggle {
  background: none;
  border: none;
  color: var(--accent);
  font-size: 22px;
  cursor: pointer;
}
#chatList, #chatWindow {
  flex: 1;
  display: none;
  flex-direction: column;
}
#chatList.active, #chatWindow.active {
  display: flex;
}
#chats {
  flex: 1;
  overflow-y: auto;
}
.chat-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  border-bottom: 1px solid #333;
  cursor: pointer;
}
.chat-item:hover { background: #111; }
.chat-item img {
  width: 40px; height: 40px; border-radius: 50%;
}
#chatMessages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}
.msg {
  max-width: 75%;
  margin: 5px 0;
  padding: 8px 10px;
  border-radius: 10px;
  word-wrap: break-word;
}
.me { align-self: flex-end; background: var(--bubble-me); }
.other { align-self: flex-start; background: var(--bubble-other); }
.msg img {
  width: 24px; height: 24px; border-radius: 50%; margin-right: 5px; vertical-align: middle;
}
#msgInput {
  display: flex;
  padding: 10px;
  background: var(--card);
}
#msgInput input {
  flex: 1;
  border: none;
  padding: 8px;
  border-radius: 5px;
}
#msgInput button {
  background: var(--accent);
  border: none;
  margin-left: 5px;
  padding: 8px 12px;
  border-radius: 5px;
  color: #000;
  font-weight: bold;
}
#backBtn {
  background: none;
  border: none;
  color: var(--accent);
  font-size: 20px;
  cursor: pointer;
  margin-right: 10px;
}
#auth {
  margin: auto;
  text-align: center;
}
#auth input, #auth button {
  display: block;
  margin: 10px auto;
  padding: 8px;
  border-radius: 5px;
  border: none;
}
#auth button {
  background: var(--accent);
  color: #000;
  font-weight: bold;
}
</style>
</head>
<body>
<header>
  <div id="headerLeft">
    <button id="backBtn" style="display:none">‚Üê</button>
    <h2>TalkSpace</h2>
  </div>
  <button id="themeToggle">üåô</button>
</header>

<div id="auth">
  <h3>–í—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
  <input id="nick" placeholder="–ù–∏–∫">
  <input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <input id="avatar" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
  <button id="reg">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  <button id="log">–í–æ–π—Ç–∏</button>
</div>

<div id="chatList">
  <button class="chat-item" id="openGlobal">
    üåê <b>–û–±—â–∏–π —á–∞—Ç</b>
  </button>
  <div id="chats"></div>
</div>

<div id="chatWindow">
  <div id="chatMessages"></div>
  <div id="msgInput">
    <input id="msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
    <button id="send">‚û§</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const s = io()
let me = {nick:"", avatar:""}
let theme = "dark"
let currentChat = null
let chats = {} // {nick:{avatar:""}}

function setTheme(t) {
  document.body.classList.toggle("light", t=="light")
  document.getElementById("themeToggle").textContent = t=="light" ? "‚òÄÔ∏è" : "üåô"
}
setTheme("dark")

document.getElementById("themeToggle").onclick = () => {
  theme = theme=="dark" ? "light" : "dark"
  setTheme(theme)
}

document.getElementById("reg").onclick = async () => {
  const nick = document.getElementById("nick").value
const pass = document.getElementById("pass").value
  const avatar = document.getElementById("avatar").value
  const res = await fetch("/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nick,pass,avatar})})
  const r = await res.json()
  alert(r.ok ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!" : r.msg)
}

document.getElementById("log").onclick = async () => {
  const nick = document.getElementById("nick").value
  const pass = document.getElementById("pass").value
  const res = await fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nick,pass})})
  const r = await res.json()
  if(!r.ok) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å")
  me.nick = nick; me.avatar = r.avatar || "https://i.ibb.co/2ZpWJ2d/user.png"
  document.getElementById("auth").style.display="none"
  document.getElementById("chatList").classList.add("active")
  s.emit("join", me.nick)
}

document.getElementById("openGlobal").onclick = ()=>{
  currentChat = "global"
  openChat("–û–±—â–∏–π —á–∞—Ç", "üåê")
}

function openChat(nick, avatar){
  document.getElementById("chatList").classList.remove("active")
  document.getElementById("chatWindow").classList.add("active")
  document.getElementById("backBtn").style.display="inline"
  document.getElementById("chatMessages").innerHTML=""
}

document.getElementById("backBtn").onclick = ()=>{
  document.getElementById("chatWindow").classList.remove("active")
  document.getElementById("chatList").classList.add("active")
  document.getElementById("backBtn").style.display="none"
  currentChat = null
}

document.getElementById("send").onclick = ()=>{
  const msg = document.getElementById("msg").value
  if(!msg) return
  if(currentChat=="global") s.emit("chatAll", msg)
  else if(currentChat) s.emit("chatPm", {to:currentChat, msg})
  document.getElementById("msg").value=""
}

s.on("chatAll", d=>{
  if(currentChat=="global"){
    addMsg(d.nick, d.msg, d.nick==me.nick)
  }
  if(!chats[d.nick] && d.nick!=me.nick){
    addChat(d.nick)
  }
})

s.on("chatPm", d=>{
  if(d.from==me.nick || d.to==me.nick){
    const partner = d.from==me.nick ? d.to : d.from
    if(!chats[partner]) addChat(partner)
    if(currentChat==partner){
      addMsg(d.from, d.msg, d.from==me.nick)
    }
  }
})

function addChat(nick){
  const div=document.createElement("div")
  div.className="chat-item"
  const img=document.createElement("img")
  img.src="https://i.ibb.co/2ZpWJ2d/user.png"
  div.appendChild(img)
  div.append(nick)
  div.onclick=()=>{currentChat=nick; openChat(nick,img.src)}
  document.getElementById("chats").appendChild(div)
  chats[nick]={avatar:img.src}
}

function addMsg(nick,msg,isMe){
  const div=document.createElement("div")
  div.className="msg "+(isMe?"me":"other")
  div.innerHTML=(isMe?"":"<img src='https://i.ibb.co/2ZpWJ2d/user.png'>")+msg
  document.getElementById("chatMessages").appendChild(div)
  div.scrollIntoView()
}
</script>
</body>
</html>
