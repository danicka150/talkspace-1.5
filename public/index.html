<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TalkSpace</title>
<style>
:root{
  --bg:#0b0b0b; --card:#0f0f0f; --text:#bfffbf; --accent:#00ff66;
  --me:#013; --other:#022;
}
.light{
  --bg:#ffffff; --card:#f3f7ff; --text:#003366; --accent:#0077ff;
  --me:#dff; --other:#eef;
}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column}
header{height:56px;background:var(--card);display:flex;align-items:center;justify-content:space-between;padding:8px 12px}
.brand{display:flex;align-items:center;gap:10px}
.brand h1{margin:0;font-size:18px}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);border:none;padding:8px 10px;border-radius:8px;color:#000;font-weight:700;cursor:pointer}
.iconbtn{background:transparent;border:none;color:var(--text);font-size:18px;cursor:pointer}
.container{flex:1;display:flex;overflow:hidden}
.sidebar{width:320px;background:var(--card);border-right:1px solid rgba(0,0,0,0.4);display:flex;flex-direction:column}
.search{padding:10px}
.search input{width:100%;padding:8px;border-radius:8px;border:0}
.list{flex:1;overflow:auto}
.item{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid rgba(255,255,255,0.02);cursor:pointer}
.item:hover{background:rgba(255,255,255,0.02)}
.avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;background:rgba(255,255,255,0.03)}
.title{font-weight:700}
.subtitle{font-size:12px;color:rgba(255,255,255,0.6)}
.main{flex:1;display:flex;flex-direction:column}
.chatHeader{height:64px;display:flex;align-items:center;gap:12px;padding:10px;border-bottom:1px solid rgba(255,255,255,0.02)}
.chatMessages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:6px}
.msg{max-width:75%;padding:10px;border-radius:12px;word-break:break-word;display:inline-flex;align-items:center;gap:8px}
.me{align-self:flex-end;background:var(--me)}
.other{align-self:flex-start;background:var(--other)}
.msg .av{width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center}
.inputRow{display:flex;padding:10px;border-top:1px solid rgba(255,255,255,0.02);gap:8px;background:var(--card)}
.inputRow input{flex:1;padding:10px;border-radius:10px;border:0}
.small{font-size:12px;color:rgba(255,255,255,0.6)}
.hidden{display:none}
.settingsPanel{position:fixed;right:12px;top:70px;background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.6);min-width:240px;z-index:40}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:50}
.box{background:var(--card);padding:12px;border-radius:10px;min-width:280px}
.row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
@media(max-width:800px){
  .sidebar{width:100%;position:fixed;top:56px;left:0;bottom:auto;height:50%;z-index:30}
  .main{position:fixed;top:56px;left:0;right:0;bottom:0}
  .hide-mobile{display:none}
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <button id="homeBtn" class="iconbtn">üè†</button>
    <h1>TalkSpace</h1>
  </div>
  <div class="controls">
    <button id="createBtn" class="btn">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
    <button id="settingsBtn" class="iconbtn">‚öôÔ∏è</button>
  </div>
</header>

<div class="container">
  <aside class="sidebar" id="sidebar">
    <div class="search">
      <input id="search" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π –∏ –ø—É–±–ª–∏—á–Ω—ã—Ö –≥—Ä—É–ø–ø">
    </div>
    <div class="list" id="list">
      <div class="item" id="globalItem"><div class="avatar">üåê</div><div><div class="title">–û–±—â–∏–π —á–∞—Ç</div><div class="subtitle">–ü–∏—Å–∞—Ç—å –º–æ–≥—É—Ç –≤—Å–µ ‚Ä¢ –∏—Å—Ç–æ—Ä–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è</div></div></div>
    </div>
  </aside>
<main class="main">
    <div id="authBox" class="box" style="margin:20px auto;max-width:420px">
      <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
      <div class="row"><input id="nick" placeholder="–ù–∏–∫" style="flex:1"></div>
      <div class="row"><input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="flex:1"></div>
      <div class="row"><input id="avatarInput" placeholder="–≠–º–æ–¥–∑–∏ –¥–ª—è –∞–≤—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä üòé)" style="flex:1"></div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button id="reg" class="btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button id="login" class="btn">–í–æ–π—Ç–∏</button>
      </div>
      <div style="margin-top:8px" class="small">–ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ —Ç—ã –ø–æ—è–≤–∏—à—å—Å—è –≤ —Å–ø–∏—Å–∫–µ —É –¥—Ä—É–≥–∏—Ö (—á–µ—Ä–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)</div>
    </div>

    <div id="chatArea" class="hidden">
      <div class="chatHeader" id="chatHeader">
        <div class="avatar" id="chatAvatar">üí¨</div>
        <div>
          <div id="chatTitle" class="title">–ß–∞—Ç</div>
          <div id="chatSub" class="small">–ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</div>
        </div>
        <div style="flex:1"></div>
        <button id="backToList" class="iconbtn hide-mobile">‚¨Ö</button>
      </div>

      <div id="messages" class="chatMessages"></div>

      <div class="inputRow" id="inputRow">
        <input id="messageInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="sendBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </main>
</div>

<!-- settings -->
<div id="settings" class="settingsPanel hidden">
  <div style="display:flex;justify-content:space-between;align-items:center"><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b><button id="closeSettings" class="iconbtn">‚úñ</button></div>
  <div style="margin-top:8px">
    <label>–¢–µ–º–∞</label>
    <select id="themeSelect" style="width:100%;padding:8px;border-radius:8px;border:0;margin-top:6px">
      <option value="dark">üåô –¢—ë–º–Ω–∞—è</option>
      <option value="light">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</option>
      <option value="neon">üíú –§–∏–æ–ª–µ—Ç–æ–≤–∞—è –Ω–µ–æ–Ω–æ–≤–∞—è</option>
      <option value="red">‚ù§Ô∏è –ö—Ä–∞—Å–Ω–æ-—á—ë—Ä–Ω–∞—è</option>
      <option value="soft">üåà –ü–∞—Å—Ç–µ–ª—å</option>
    </select>
  </div>
  <div style="margin-top:8px">
    <label>–¢–≤–æ–π –∞–≤–∞—Ç–∞—Ä (—ç–º–æ–¥–∑–∏)</label>
    <input id="myAvatar" placeholder="üòé" style="width:100%;padding:8px;border-radius:8px;border:0;margin-top:6px">
  </div>
</div>

<!-- create group modal -->
<div id="createModal" class="modal hidden">
  <div class="box">
    <h3>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h3>
    <div class="row"><input id="groupName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" style="flex:1"></div>
    <div class="row"><input id="groupEmoji" placeholder="–≠–º–æ–¥–∑–∏ –¥–ª—è –∞–≤—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä üéÆ)" style="flex:1"></div>
    <div class="row">
      <label><input type="radio" name="gtype" value="public" checked> –ü—É–±–ª–∏—á–Ω–∞—è</label>
      <label style="margin-left:8px"><input type="radio" name="gtype" value="private"> –ü–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="createCancel" class="btn">–û—Ç–º–µ–Ω–∞</button>
      <button id="createOk" class="btn">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
/* –ü—Ä–æ—Å—Ç–∞—è, –Ω–æ —Ä–∞–±–æ—á–∞—è –ª–æ–≥–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è TalkSpace.
   –†–∞–±–æ—Ç–∞–µ—Ç —Å server.js –∫–æ—Ç–æ—Ä—ã–π —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å.
   - –æ—Ç–ø—Ä–∞–≤–∫–∞ chatAll –∏ chatPm
   - –º–µ—Ö–∞–Ω–∏–∫–∞ –≥—Ä—É–ø–ø —á–µ—Ä–µ–∑ —Å–ø–µ—Ü-—Å–æ–æ–±—â–µ–Ω–∏—è
   - –ø–æ–∏—Å–∫, –ø—É–±–ª–∏—á–Ω—ã–µ –≥—Ä—É–ø–ø—ã, –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
   - localStorage –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Ç–æ–≤/–≥—Ä—É–ø–ø/–Ω–∞—Å—Ç—Ä–æ–µ–∫
*/

// ---- helpers ----
const byId = id => document.getElementById(id)
const save = (k,v) => localStorage.setItem(k, JSON.stringify(v))
const load = k => { try { return JSON.parse(localStorage.getItem(k)||'null') } catch(e){ return null }}

// ---- state ----
const socket = io()
let me = load('ts_me') || {nick:'', avatar:'üòé'}
let users = load('ts_users') || {}   // nick -> {avatar}
let groups = load('ts_groups') || {} // id -> {name,emoji,public,members:[]}
let chatsLocal = load('ts_chats') || {} // key-> [msgs], key: user:nick or group:id or 'global' but global not saved
let current = {type:'none', id:null} // type: global|user|group
let searchTimer = null
// ---- UI refs ----
const listEl = byId('list'), messagesEl = byId('messages'), chatArea = byId('chatArea'), authBox = byId('authBox')
const nickI = byId('nick'), passI = byId('pass'), avatarI = byId('avatarInput')
const regBtn = byId('reg'), loginBtn = byId('login'), sendBtn = byId('sendBtn'), msgI = byId('messageInput')
const createBtn = byId('createBtn'), createModal = byId('createModal'), createOk = byId('createOk'), createCancel = byId('createCancel')
const groupNameI = byId('groupName'), groupEmojiI = byId('groupEmoji')
const settingsBtn = byId('settingsBtn'), settingsPanel = byId('settings'), closeSettings = byId('closeSettings'), themeSelect = byId('themeSelect'), myAvatarI = byId('myAvatar')
const searchI = byId('search'), globalItem = byId('globalItem'), backToList = byId('backToList'), homeBtn = byId('homeBtn')

// ---- init UI from storage ----
function applyTheme(t){
  document.body.classList.remove('light')
  if(t==='light') document.body.classList.add('light')
  else if(t==='neon'){ document.body.style.setProperty('--bg','#070014'); document.body.style.setProperty('--card','#140022'); document.body.style.setProperty('--text','#ff66ff'); document.body.style.setProperty('--accent','#ff66ff'); }
  else if(t==='red'){ document.body.style.setProperty('--bg','#100000'); document.body.style.setProperty('--card','#200000'); document.body.style.setProperty('--text','#ff9b9b'); document.body.style.setProperty('--accent','#ff4d4d'); }
  else if(t==='soft'){ document.body.style.setProperty('--bg','#fbfbff'); document.body.style.setProperty('--card','#f6f7ff'); document.body.style.setProperty('--text','#235'); document.body.style.setProperty('--accent','#8aa'); }
}
const settings = load('ts_settings') || {theme:'dark'}
applyTheme(settings.theme)
themeSelect.value = settings.theme
if(me.avatar) myAvatarI.value = me.avatar

// ---- util: render list of users and groups ----
function renderList(q){
  listEl.innerHTML = ''
  // global first (already in markup but re-add to keep order)
  listEl.appendChild(globalItem)
  // groups public
  const ql = (q||'').toLowerCase()
  // my groups header
  const myHeader = el('div',{class:'item'}, elAvatar('üë•'), elText('–ú–æ–∏ –≥—Ä—É–ø–ø—ã','–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ –≥—Ä—É–ø–ø—ã'))
  myHeader.onclick = ()=>{ showMyGroups() }
  listEl.appendChild(myHeader)
  // public groups
  Object.keys(groups).forEach(id=>{
    const g = groups[id]
    if(g.public && (ql===''  g.name.toLowerCase().includes(ql)  (g.emoji||'').includes(ql))){
      const node = el('div',{class:'item'}, elAvatar(g.emoji||'üë•'), elText(g.name, g.public ? '–ü—É–±–ª–∏—á–Ω–∞—è –≥—Ä—É–ø–ø–∞' : '–ü—Ä–∏–≤–∞—Ç–Ω–∞—è'))
      node.onclick = ()=>{ openChatGroup(id) }
      listEl.appendChild(node)
    }
  })
  // users
  const usersArr = Object.keys(users).filter(n=>n!==me.nick).sort()
  usersArr.forEach(n=>{
    if(ql && !n.toLowerCase().includes(ql)) return
    const u = users[n]
    const node = el('div',{class:'item'}, elAvatar(u.avatar||'üòé'), elText(n,'–õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'))
    node.onclick = ()=> openChatUser(n)
    listEl.appendChild(node)
  })
}

// ---- small dom helpers ----
function el(tag,attrs, ...children){
  const d = document.createElement(tag||'div')
  if(attrs) Object.keys(attrs).forEach(k=>d.setAttribute(k, attrs[k]))
  children.forEach(c=>{ if(typeof c==='string') d.appendChild(document.createTextNode(c)); else d.appendChild(c) })
  return d
}
function elAvatar(ch){ const a = document.createElement('div'); a.className='avatar'; a.textContent = ch||'üòé'; return a }
function elText(title, sub){ const d = document.createElement('div'); const t = document.createElement('div'); t.className='title'; t.textContent = title; d.appendChild(t); if(sub){ const s=document.createElement('div'); s.className='subtitle'; s.textContent=sub; d.appendChild(s)} return d }

// ---- chat UI ----
function openChatGlobal(){
  current = {type:'global', id:'global'}
  showChatHeader('–û–±—â–∏–π —á–∞—Ç','–í—Å–µ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å (–∏—Å—Ç–æ—Ä–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)', 'üåê')
  loadMessagesToUI('global')
}
function openChatUser(nick){
  current = {type:'user', id:nick}
  showChatHeader(nick,'–õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', users[nick]?.avatar || 'üòé')
  loadMessagesToUI('user:'+nick)
}
function openChatGroup(id){
  const g = groups[id]
  current = {type:'group', id}
  showChatHeader(g.name, g.public ? '–ü—É–±–ª–∏—á–Ω–∞—è –≥—Ä—É–ø–ø–∞' : '–ü—Ä–∏–≤–∞—Ç–Ω–∞—è (–ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é)', g.emoji||'üë•')
  loadMessagesToUI('group:'+id)
}
function showChatHeader(title, sub, avatar){
  byId('chatTitle').textContent = title
  byId('chatSub').textContent = sub
  byId('chatAvatar').textContent = avatar||'üí¨'
  authBox.style.display = 'none'
  chatArea.classList.remove('hidden')
  byId('chatArea') // ensure visible
}
function showMyGroups(){
  listEl.innerHTML = ''
  listEl.appendChild(globalItem)
  const header = el('div',{class:'item'}, elAvatar('üë•'), elText('–ú–æ–∏ –≥—Ä—É–ø–ø—ã','–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è'))
  header.onclick = ()=> renderList(searchI.value)
  listEl.appendChild(header)
  Object.keys(groups).forEach(id=>{
    const g = groups[id]
    if((g.members||[]).includes(me.nick)){
      const node = el('div',{class:'item'}, elAvatar(g.emoji||'üë•'), elText(g.name, g.public ? '–ü—É–±–ª–∏—á–Ω–∞—è' : '–ü–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é'))
      node.onclick = ()=> openChatGroup(id)
      listEl.appendChild(node)
    }
  })
}

// ---- messages store/keys ----
// key examples: 'user:Bob', 'group:123', 'global' (global not saved)
function chatKeyFor(type,id){
  if(type==='user') return 'user:'+id
  if(type==='group') return 'group:'+id
  return id
}
function loadMessagesToUI(key){
  messagesEl.innerHTML = ''
  const arr = chatsLocal[key] || []
  arr.forEach(m => appendMsgToUI(m))
  scrollBottom()
}
function appendMsgToStoreAndUI(key,msg){
  chatsLocal[key] = chatsLocal[key] || []
  chatsLocal[key].push(msg)
  save('ts_chats', chatsLocal)
  appendMsgToUI(msg)
}
function appendMsgToUI(m){
  const d = document.createElement('div')
  d.className = 'msg ' + (m.from === me.nick ? 'me' : 'other')
  const av = document.createElement('div'); av.className='av'; av.textContent = (m.avatar  (users[m.from] && users[m.from].avatar)  'üòé')
  const t = document.createElement('div'); t.style.display='flex'; t.style.flexDirection='column'
  const bold = document.createElement('div'); bold.style.fontWeight='700'; bold.textContent = m.from
  const text = document.createElement('div'); text.textContent = m.text
  t.appendChild(bold); t.appendChild(text)
  if(m.from === me.nick){ d.appendChild(text) } else { d.appendChild(av); d.appendChild(t) }
  // for my messages show text (align right)
  if(m.from === me.nick){ d.innerHTML = '<div style="padding:0 8px">'+escapeHtml(m.text)+'</div>' }
  messagesEl.appendChild(d)
}
function scrollBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight }

// ---- escape simple
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

// ---- networking: special commands encoded in messages ----
function announcePresence(){
  // broadcast to everyone your avatar so clients learn about users
  const payload = {cmd:'TS_USER', avatar: me.avatar}
  socket.emit('chatAll', JSON.stringify(payload))
}
function createGroupBroadcast(id, group){
  // public group creation broadcast so everyone sees it
  const payload = {cmd:'TS_CREATE_GROUP', id, group}
  socket.emit('chatAll', JSON.stringify(payload))
}
function sendInvite(toNick, groupId){
  // send a chatPm invite specifically to user
  const payload = {cmd:'TS_INVITE', groupId, from: me.nick}
  socket.emit('chatPm', {to: toNick, msg: JSON.stringify(payload)})
}

// ---- socket handlers ----
socket.on('connect', ()=>{ /* connected */ })
socket.on('chatAll', d=>{
  // d: {nick, msg}
  try{
    const msg = typeof d.msg === 'string' ? JSON.parse(d.msg) : null
    if(msg && msg.cmd==='TS_USER'){
      users[d.nick] = users[d.nick] || {}
      users[d.nick].avatar = msg.avatar  users[d.nick].avatar  'üòé'
      save('ts_users', users)
      renderList(searchI.value)
      return
    }
    if(msg && msg.cmd==='TS_CREATE_GROUP'){
      const id = msg.id; const g = msg.group
      groups[id] = g
      save('ts_groups', groups)
      renderList(searchI.value)
      return
    }
    // normal public message: show in global if open
    if(current.type==='global'){
      appendMsgToStoreAndUI('global', {from: d.nick, text: d.msg, avatar: users[d.nick]?.avatar})
    }
    // also record that user exists
    users[d.nick] = users[d.nick] || {avatar: 'üòé'}
    save('ts_users', users)
    renderList(searchI.value)
  }catch(e){
    // if not JSON, treat as plain
    if(current.type==='global'){
      appendMsgToStoreAndUI('global', {from: d.nick, text: d.msg, avatar: users[d.nick]?.avatar})
    }
  }
})

socket.on('chatPm', d=>{
  // d: {from, to, msg}
  // if msg is JSON command: invite or group message etc
  let parsed = null
  try{ parsed = JSON.parse(d.msg) } catch(e){ parsed = null }
  // invite handling
  if(parsed && parsed.cmd==='TS_INVITE'){
    if(d.to === me.nick){
      const gid = parsed.groupId
      // join group: add to groups and mark membership
      if(groups[gid]){
        groups[gid].members = groups[gid].members || []
        if(!groups[gid].members.includes(me.nick)) groups[gid].members.push(me.nick)
        save('ts_groups', groups)
        alert('–¢–µ–±—è –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏ –≤ –≥—Ä—É–ø–ø—É: ' + groups[gid].name)
        renderList(searchI.value)
      }
    }
    return
  }
  // group message? to startsWith group:
  if(typeof d.to === 'string' && d.to.startsWith('group:')){
    const gid = d.to.split(':',2)[1]
    const key = 'group:'+gid
    // only show if member or public
    const g = groups[gid]
    const isMember = g && (g.public  (g.members[]).includes(me.nick))
    if(!g) {
      // If group unknown, create minimal placeholder (public unknown?) - skip if private
      // We'll not auto-add private unknown groups
      // But if message exists, add placeholder and mark member if to includes me
      groups[gid] = groups[gid] || {name: gid, emoji:'üë•', public:false, members:[]}
      save('ts_groups', groups)
    }
    // add to store for everyone (server saved it)
    appendMsgToStoreAndUI(key, {from: d.from, text: d.msg, avatar: users[d.from]?.avatar})
    renderList(searchI.value)
    return
  }
  // normal pm between users
  const key = 'user:' + (d.from === me.nick ? d.to : d.from)
  appendMsgToStoreAndUI(key, {from: d.from, text: d.msg, avatar: users[d.from]?.avatar})
  // if it's for me or from me, ensure user is known
  users[d.from] = users[d.from] || {avatar:'üòé'}
  save('ts_users', users)
  renderList(searchI.value)
})

// ---- actions: register/login/send/create/invite ----
regBtn.onclick = async ()=>{
  const nick = nickI.value.trim(); const pass = passI.value; const avatar = avatarI.value.trim() || 'üòé'
  if(!nick || !pass) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å')
  const res = await fetch('/register',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({nick, pass, avatar})})
  const r = await res.json()
  if(r.ok){ alert('–ì–æ—Ç–æ–≤–æ, —Ç–µ–ø–µ—Ä—å –≤–æ–π–¥–∏'); nickI.value = nick } else alert(r.msg || '–û—à–∏–±–∫–∞')
}
loginBtn.onclick = async ()=>{
  const nick = nickI.value.trim(); const pass = passI.value
  if(!nick || !pass) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å')
  const res = await fetch('/login',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({nick, pass})})
  const r = await res.json()
  if(!r.ok) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å')
me.nick = nick; me.avatar = r.avatar  (avatarI.value.trim()  'üòé')
  save('ts_me', me)
  // hide auth, show UI
  authBox.style.display = 'none'
  chatArea.classList.remove('hidden')
  // announce presence to all
  socket.emit('join', me.nick)
  announcePresence()
  renderList('')
  openChatGlobal()
}

sendBtn.onclick = ()=>{
  const text = msgI.value.trim()
  if(!text) return
  if(current.type==='global'){
    socket.emit('chatAll', text)
    appendMsgToStoreAndUI('global', {from: me.nick, text, avatar: me.avatar})
  } else if(current.type==='user'){
    const to = current.i